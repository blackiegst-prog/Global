<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<title>Î‘Ï€Î¿Î³ÏÎ±Ï†Î® Î ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#f4f4f4;padding:10px}
h1{text-align:center}
#scanner{height:300px;background:#000;margin-bottom:10px}
input,select,button{width:100%;padding:8px;margin:4px 0}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ccc;padding:6px;text-align:center;font-size:13px}
th{background:#eee}
@media print{#scanner,input,button{display:none}}
</style>
</head>

<body>
<h1>ğŸ“¦ Î‘Ï€Î¿Î³ÏÎ±Ï†Î® Î ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½</h1>

<button id="btnScan">ğŸ“· Î†Î½Î¿Î¹Î³Î¼Î± ÎšÎ¬Î¼ÎµÏÎ±Ï‚</button>
<div id="scanner"></div>

<input id="search" placeholder="ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·" onkeyup="updateTable()">

<select id="categoryFilter" onchange="updateTable()">
    <option value="">ğŸ“‚ ÎŒÎ»ÎµÏ‚ Î¿Î¹ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</option>
</select>

<button onclick="exportExcel()">ğŸ“Š Export Excel</button>
<button onclick="backup()">ğŸ’¾ Backup</button>
<input type="file" onchange="restore(event)">
<button onclick="window.print()">ğŸ–¨ Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·</button>

<table>
<thead>
<tr>
<th>Barcode</th>
<th>ÎŒÎ½Î¿Î¼Î±</th>
<th>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</th>
<th>Î Î¿Ïƒ.</th>
<th>+</th>
<th>-</th>
<th>ğŸ—‘</th>
</tr>
</thead>
<tbody id="productTable"></tbody>
</table>

<script>
let products = JSON.parse(localStorage.getItem("products")) || {};
let scannerInstance = null;

function save(){localStorage.setItem("products",JSON.stringify(products));}

function updateCategories(){
    const sel=document.getElementById("categoryFilter");
    const current = sel.value;
    const cats=[...new Set(Object.values(products).map(p=>p.category))];
    sel.innerHTML='<option value="">ğŸ“‚ ÎŒÎ»ÎµÏ‚</option>';
    cats.forEach(c=>{
        sel.innerHTML+=`<option ${c===current?"selected":""}>${c}</option>`;
    });
}

function updateTable(){
    const s=document.getElementById("search").value.toLowerCase();
    const f=document.getElementById("categoryFilter").value;
    const tb=document.getElementById("productTable");
    tb.innerHTML="";
    for(let c in products){
        const p=products[c];
        if((!f||p.category===f)&&(p.name.toLowerCase().includes(s)||c.includes(s))){
            tb.innerHTML+=`
            <tr>
            <td>${c}</td>
            <td>${p.name}</td>
            <td>${p.category}</td>
            <td>${p.qty}</td>
            <td><button onclick="chg('${c}',1)">+</button></td>
            <td><button onclick="chg('${c}',-1)">-</button></td>
            <td><button onclick="delProd('${c}')">ğŸ—‘</button></td>
            </tr>`;
        }
    }
    updateCategories();
}

function chg(c,v){
    products[c].qty=Math.max(0,products[c].qty+v);
    save();updateTable();
}
function delProd(c){
    if(confirm("Î”Î¹Î±Î³ÏÎ±Ï†Î®;")){
        delete products[c];
        save();updateTable();
    }
}

async function getName(code){
    try{
        let r=await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
        let d=await r.json();
        if(d.status==1) return d.product.product_name;
    }catch(e){}
    return null;
}

/* ===== CAMERA / SCANNER ===== */
document.getElementById("btnScan").addEventListener("click", async ()=>{
    const scannerDiv = document.getElementById("scanner");
    scannerDiv.innerHTML="";

    // iOS Safari: BarcodeDetector
    if('BarcodeDetector' in window){
        const video = document.createElement("video");
        video.setAttribute("playsinline", true);
        video.style.width = "100%";
        scannerDiv.appendChild(video);

        try{
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;
            await video.play();

            const barcodeDetector = new BarcodeDetector({ formats: ['ean_13','ean_8','code_128'] });

            const scanLoop = async () => {
                const barcodes = await barcodeDetector.detect(video);
                if(barcodes.length > 0){
                    const code = barcodes[0].rawValue;
                    addProduct(code);
                    stream.getTracks().forEach(track => track.stop());
                    video.remove();
                    return;
                }
                requestAnimationFrame(scanLoop);
            };
            scanLoop();

        } catch(e){
            alert("âŒ Î”ÎµÎ½ Î´ÏŒÎ¸Î·ÎºÎµ Î¬Î´ÎµÎ¹Î± ÎºÎ¬Î¼ÎµÏÎ±Ï‚ Î® ÏƒÏ†Î¬Î»Î¼Î±: "+e);
        }
        return;
    }

    // fallback: Html5Qrcode Î³Î¹Î± Android / Desktop
    if(scannerInstance) return;
    scannerInstance = new Html5Qrcode("scanner");
    try{
        await scannerInstance.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            async (decodedText)=>{
                addProduct(decodedText);
                scannerInstance.stop();
                scannerInstance=null;
            }
        );
    }catch(e){
        alert("âŒ Î£Ï†Î¬Î»Î¼Î± ÎºÎ¬Î¼ÎµÏÎ±Ï‚: "+e);
        scannerInstance=null;
    }
});

async function addProduct(code){
    if(products[code]){
        products[code].qty++;
    } else {
        let name = await getName(code) || prompt("ÎŒÎ½Î¿Î¼Î± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚:");
        if(!name) return;
        let cat = prompt("ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±:") || "Î§Ï‰ÏÎ¯Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±";
        products[code] = { name, category: cat, qty: 1 };
    }
    save(); updateTable();
}

/* ====== EXPORT / BACKUP ====== */
function exportExcel(){
    const d=[["Barcode","ÎŒÎ½Î¿Î¼Î±","ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±","Î Î¿ÏƒÏŒÏ„Î·Ï„Î±"]];
    for(let c in products){
        d.push([c,products[c].name,products[c].category,products[c].qty]);
    }
    const ws=XLSX.utils.aoa_to_sheet(d);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Î‘Ï€Î¿Î³ÏÎ±Ï†Î®");
    XLSX.writeFile(wb,"apografi.xlsx");
}

function backup(){
    const blob=new Blob([JSON.stringify(products)],{type:"application/json"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="backup.json";
    a.click();
}

function restore(e){
    const r=new FileReader();
    r.onload=()=>{products=JSON.parse(r.result);save();updateTable();}
    r.readAsText(e.target.files[0]);
}

updateTable();
</script>
</body>
</html>
